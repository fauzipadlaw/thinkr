name: Check Build Branch Status

on:
  pull_request:
    branches:
      - build
    types: [opened, synchronize, reopened]

jobs:
  check_running_workflows:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check for running workflows on build branch
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = 'build';
            
            // Get all workflow runs for the build branch
            const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              branch,
              status: 'in_progress',
              per_page: 100
            });
            
            // Filter out the current workflow run (this check itself)
            const currentRunId = context.runId;
            const runningWorkflows = workflowRuns.workflow_runs.filter(
              run => run.id !== currentRunId
            );
            
            if (runningWorkflows.length > 0) {
              const workflowNames = runningWorkflows.map(run => 
                `- ${run.name} (${run.html_url})`
              ).join('\n');
              
              core.setFailed(
                `Cannot merge: ${runningWorkflows.length} workflow(s) currently running on 'build' branch:\n${workflowNames}\n\n` +
                `Please wait for these workflows to complete before merging.`
              );
            } else {
              console.log('✅ No workflows currently running on build branch. Safe to merge.');
            }

  check_queued_workflows:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check for queued workflows on build branch
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = 'build';
            
            // Get all queued workflow runs for the build branch
            const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              branch,
              status: 'queued',
              per_page: 100
            });
            
            // Filter out the current workflow run
            const currentRunId = context.runId;
            const queuedWorkflows = workflowRuns.workflow_runs.filter(
              run => run.id !== currentRunId
            );
            
            if (queuedWorkflows.length > 0) {
              const workflowNames = queuedWorkflows.map(run => 
                `- ${run.name} (${run.html_url})`
              ).join('\n');
              
              core.setFailed(
                `Cannot merge: ${queuedWorkflows.length} workflow(s) queued on 'build' branch:\n${workflowNames}\n\n` +
                `Please wait for these workflows to complete before merging.`
              );
            } else {
              console.log('✅ No workflows queued on build branch. Safe to merge.');
            }

  all_clear:
    runs-on: ubuntu-latest
    needs: [check_running_workflows, check_queued_workflows]
    if: always()
    
    steps:
      - name: Verify all checks passed
        run: |
          if [[ "${{ needs.check_running_workflows.result }}" != "success" ]] || [[ "${{ needs.check_queued_workflows.result }}" != "success" ]]; then
            echo "❌ Cannot merge: workflows are running or queued on build branch"
            exit 1
          fi
          echo "✅ All clear: no workflows running on build branch. Safe to merge."
